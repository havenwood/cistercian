<h1>Cistercian Numerals</h1>

<search class="controls">
  <div class="input-wrapper">
    <div id="input_backdrop" aria-hidden="true"><%= @initial_backdrop %></div>
    <input
      type="text"
      name="input"
      id="number_input"
      value="<%= @initial_input %>"
      placeholder="Numerals 0-9999..."
      hx-post="/numerals"
      hx-trigger="input changed delay:100ms"
      hx-target="#numerals"
      hx-swap="morph:innerHTML transition:true"
      hx-include="[name='secret_mode']"
      autocomplete="one-time-code"
      autocorrect="off"
      autocapitalize="off"
      data-form-type="other"
      data-lpignore="true"
      spellcheck="false"
      autofocus
    >
  </div>
  <label class="toggle toggle-right">
    <input type="checkbox" name="secret_mode" value="1"
      aria-label="Secret mode"
      hx-post="/numerals"
      hx-trigger="change"
      hx-target="#numerals"
      hx-swap="morph:innerHTML transition:true"
      hx-include="[name='input']"
      onchange="toggleSecretMode()"
    >
    <span class="slider"></span>
  </label>
</search>
<script>
  function toggleSecretMode() {
    const input = document.getElementById('number_input');
    const secret = document.querySelector('[name="secret_mode"]').checked;
    input.classList.toggle('hidden-text', secret);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('number_input');
    const secretMode = document.querySelector('[name="secret_mode"]');

    // Reduce iOS Safari scroll jank on touch devices
    if (window.matchMedia('(pointer: coarse)').matches) {
      input.setAttribute('hx-trigger', 'input changed delay:400ms');
      htmx.process(input);
    }

    // Move cursor to end of initial value (once)
    if (input.value) {
      const moveCursorToEnd = () => {
        setTimeout(() => {
          input.setSelectionRange(input.value.length, input.value.length);
        }, 0);
        input.removeEventListener('focus', moveCursorToEnd);
      };
      if (document.activeElement === input) {
        moveCursorToEnd();
      } else {
        input.addEventListener('focus', moveCursorToEnd);
      }
    }

    // Prevent toggle from stealing focus
    secretMode.parentElement.addEventListener('mousedown', (event) => {
      event.preventDefault();
    });

    // Escape key clears input
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        input.value = '';
        htmx.ajax('POST', '/numerals', {
          target: '#numerals',
          swap: 'morph:innerHTML transition:true',
          values: { input: '', secret_mode: secretMode.checked ? '1' : '0' }
        });
      }
    });

    // Glow corresponding digits when clicking a numeral
    document.getElementById('numerals').addEventListener('click', (e) => {
      const figure = e.target.closest('figure');
      if (figure) {
        const index = figure.id.replace('fig-', '');
        const span = document.querySelector(`#input_backdrop [data-chunk="${index}"]`);
        if (span) {
          span.classList.remove('glow');
          // Force reflow to restart animation
          void span.offsetWidth;
          span.classList.add('glow');
          span.onanimationend = () => span.classList.remove('glow');
        }
      }
    });
  });
</script>

<main id="numerals"><%= @initial_numerals %></main>
